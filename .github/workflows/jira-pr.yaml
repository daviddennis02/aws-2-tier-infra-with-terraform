name: Jira PR Automation

on:
  repository_dispatch:
    types: [jira_transition]

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Jira Issue Details
        id: jira_info
        uses: actions/github-script@v6
        with:
          script: |
            const payload = context.payload.client_payload;
            const issueKey = payload.issue.key;
            const issueSummary = payload.issue.fields.summary;
            const changelog = payload.changelog;

            // Check if the status actually changed to "REQUEST FOR RELEASE"
            if (changelog && changelog.items.some(item => item.field == 'status' && item.to == 'REQUEST FOR RELEASE')) { // Replace "REQUEST FOR RELEASE"
              const branchName = `feature/${issueKey}-${issueSummary.replace(/\s+/g, '-').toLowerCase()}`;
              core.setOutput('issueKey', issueKey);
              core.setOutput('branchName', branchName);
              core.setOutput('issueSummary', issueSummary); // Output the summary
            } else {
              core.setFailed('Issue not transitioned to REQUEST FOR RELEASE.  Exiting.'); // Fail the workflow
            }

      - name: Create/Checkout Feature Branch
        if: steps.jira_info.outcome == 'success' # Only run if the status change was correct
        run: |
          git checkout -b ${{ steps.jira_info.outputs.branchName }} || git checkout ${{ steps.jira_info.outputs.branchName }}

      - name: Make Changes (Your Code Changes Here)
        if: steps.jira_info.outcome == 'success'
        run: |
          # ... (Your code change commands) ...
          git add .
          git commit -m "Automated commit for ${issueKey}: ${issueSummary}"

      - name: Push Changes
        if: steps.jira_info.outcome == 'success'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.jira_info.outputs.branchName }}

      - name: Create Pull Request
        if: steps.jira_info.outcome == 'success'
        uses: peter-murray/github-automatic-pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          head: ${{ steps.jira_info.outputs.branchName }}
          title: "PR: ${{ steps.jira_info.outputs.issueKey }} - ${{ steps.jira_info.outputs.branchName }}"
          body: |
            Automated PR created for Jira ticket ${{ steps.jira_info.outputs.issueKey }}.
            Ticket Summary: ${{ steps.jira_info.outputs.issueSummary }}
            [Link to Jira Ticket](YOUR_JIRA_URL/browse/${{ steps.jira_info.outputs.issueKey }})
          automatic_merge: false